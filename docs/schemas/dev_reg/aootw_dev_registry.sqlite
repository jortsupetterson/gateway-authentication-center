CREATE TABLE aaotw_clients (
  application_id                TEXT PRIMARY KEY,               -- julkinen tunniste
  rp_id                         BLOB NOT NULL CHECK (length(rp_id) = 32)
                                   REFERENCES accounts(rp_id) ON DELETE CASCADE,

  display_name                  TEXT NOT NULL,
  domain                        TEXT NOT NULL,                  -- eTLD+1, punycode, lowercase
  domain_verification_status    INTEGER NOT NULL DEFAULT 0,     -- 0=pending,1=verified,2=rejected
  domain_verification_method    TEXT,
  domain_verified_at            INTEGER NOT NULL DEFAULT 0,

  redirect_uris                 TEXT NOT NULL CHECK (json_valid(redirect_uris)),
  grant_types                   TEXT NOT NULL CHECK (json_valid(grant_types)),
  response_types                TEXT NOT NULL CHECK (json_valid(response_types)),
  scopes                        TEXT NOT NULL CHECK (json_valid(scopes)),

  allowed_origins               TEXT CHECK (allowed_origins IS NULL OR json_valid(allowed_origins)),

  policy_uri                    TEXT,
  tos_uri                       TEXT,

  status                        INTEGER NOT NULL DEFAULT 1,
  epoch                         INTEGER NOT NULL DEFAULT 1,

  created_at                    INTEGER NOT NULL,
  updated_at                    INTEGER NOT NULL
) STRICT;

CREATE TABLE developers (
  developer_id                  BLOB PRIMARY KEY CHECK (length(developer_id) = 32),

  notification_email            TEXT CHECK (notification_email IS NULL OR notification_email GLOB '*@*.*'),
  notification_email_verified_status INTEGER NOT NULL DEFAULT 0,
  notification_email_verified_at INTEGER NOT NULL DEFAULT 0,

  status                        INTEGER NOT NULL DEFAULT 1,      -- 1=active,0=disabled,2=suspended
  epoch                         INTEGER NOT NULL DEFAULT 1,      -- tilin rotaatio/versio

  created_at                    INTEGER NOT NULL,               -- unix ms
  updated_at                    INTEGER NOT NULL                -- unix ms
) STRICT;

CREATE TABLE billing (
  developer_id                  BLOB PRIMARY KEY CHECK (length(developer_id) = 32)
                                   REFERENCES developers(developer_id) ON DELETE CASCADE,

  plan_code                     TEXT NOT NULL DEFAULT 'free',
  soft_limit_events_month       INTEGER NOT NULL DEFAULT 100000,
  hard_limit_events_month       INTEGER NOT NULL DEFAULT 200000,
  current_month_events          INTEGER NOT NULL DEFAULT 0,

  last_budget_notify_at         INTEGER NOT NULL DEFAULT 0,
  billing_epoch                 INTEGER NOT NULL DEFAULT 1,

  updated_at                    INTEGER NOT NULL
) STRICT;
